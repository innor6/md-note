### ARP：地址解析协议

从逻辑IP到对应物理硬件地址的翻译。在物理网络内发送。

1. 提供32bitIP地址-->48bit以太网地址的映射。（不一定是以太网，也可以是其他的物理网络）
2. 一个网络接口有一个硬件地址；点对点链路不使用ARP。
3. RARP提供逆向的映射。
4. ARP是硬件自动完成的动态映射，对应用程序和管理员透明；而RARP被无盘工作站使用，需要管理员手动设置。

**ARP过程**(2ms)：

在以太网内发送一个IP数据报时，若不知道目标主机的MAC地址，需要进行ARP。

1. 广播：发送一份ARP请求的以太网帧（who-has 192.168.1.109）给以太网上的每个主机。

   - 太网广播地址为ff:ff:ff:ff:ff:ff

   - 帧中包含[MAC: IP]四元组表，其中目的主机的MAC为空，稍后由目的主机填写

2. 应答：目的主机识别出请求的是是自己的IP后，发送一个ARP应答，包含IP和对应的MAC（192.168.1.109 is at xx:xx:xx:xx:xx:xx）

### DNS：域名系统

将域名转换为ip地址。

应用程序请求TCP打开连接或用UDP发送数据报之前，必须先把主机名转换为一个IP地址。

端口号53，一般用UDP。

查询方式：分为递归、迭代。

### IP模块

路由器转发过程中，IP数据包的源IP、目的IP始终不变

分片：由于片偏移的单位为8字节，因此前面的分片数据部分是8的倍数（如20+1480），最后一个分片不用MF（more fregment）标志位

主机启用转发功能：`echo 1>/proc/sys/net/ipv4/ip_forward`

校验和：IP数据包只校验头部，TCP校验头部+数据（保证可靠）。

### TCP模块

**MSS**：最大分节长度，数据部分长度，MTU-20-20（IP、TCP头部）

**TIME_WAIT**：等待2MSL，最大报文生存时间

- 可靠的终止TCP连接：主动关闭端收到FIN后，其发送的ACK可能丢失，则会在最长2MSL的时间内收到对方会重传的FIN。

- 让本次TCP连接的所有数据报都从网络上消失，防止与下次连接的报文混淆。

  （可用选项：SO_REUSEADDR端口重用，无需等待，立即使用处于TIME_WAIT状态的端口）

**RST**：

1. 发起连接：目标端口不存在，或处于TIME_WAIT状态
2. 终止连接：异常地终止一个连接（相对于FIN）
3. 处理半打开连接：服务器崩溃重启，连接已不存在，没法发送FIN，另一方不知情，继续向不存在的连接write，则收到RST

**交互数据流——延迟确认：**

收到数据后，不是马上ACK，而是在下一次发送数据时捎带这个ACK。

只适用于处理请求较快的场景。可以减少网络中报文段数量。

**交互数据流——Nagle算法：**

每次发完一个TCP分节后，直到收到ACK后，或累积的数据量超过MSS，才继续发下一个TCP分节。

通过累计多个分节，单次发送，减少网络中的TCP分节、防止拥塞。

特点：确认到达越快，数据发的越快。

缺点：两次数据的发送间隔一个RTT，延迟会变高，影响请求流水线，带宽利用率低。

解决办法：

1. 建立缓冲区，将多个发送请求合并发送；
2. 禁用：TCP_NODELAY



**UDP  vs TCP**

TCP：面向连接、可靠的、字节流协议

UDP：无连接、不可靠的、数据报协议

TCP有流量控制和拥塞控制。

**并发**

TCP：线程不安全，因此服务器一般一个客户分配一个sockfd

UDP：线程安全，服务器只需一个sockfd即可

**TCP的可靠性**

发送-应答（ACK）确认数据收到：数值为期待收到的下一个字节的序号

超时重传

序列号（seq）确保有序：该报文段的第一个字节在整个字节流的偏移

校验和：校验头部+数据