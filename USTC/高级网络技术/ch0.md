# history

Paul Baran的分布式通信设计：

- 动态路由，分组交换转发报文，分布式系统。
- 无连接：简单、灵活、可扩展性、健壮。
- 场景限制：适用于低负载、短消息的。
- 实现：Internet

面向连接（电话系统）：每个部件通过冗余实现高可靠性，适合高负载的场景。



### 协议

链路层：以太网、令牌环网、点对点链路？

网络层：IP、ICMP、IGMP、ARP、OSPF

传输层：TCP、UDP

应用层



# chapter 1

baran 3点:
分组交换
动态路由
出错后由客户处理



数据报转发过程中，物理地址逐跳而变（物理结点间），逻辑地址（IP）保持不变。



**CDMA/CD**

标准以太网的逻辑拓扑是总线型的，所有设备共用信道，发送帧其实是广播，会发生碰撞，因此使用半双工的CDMA/CD。

- 发前先听
- 基于最小帧长（RTT*带宽）的边发边听
- 碰撞后采用二进制指数退避



- 集线器：信号的再生，直接广播
- 网桥：根据mac将帧转发到对应的端口（自学习；转发时帧的mac不变；一个端口一个碰撞域，即分割了碰撞域，连接的局域网的各个网段）
- 路由器：根据IP转发数据报（转发后mac改变；连接的是几个独立的局域网，构成互联网）  



冲突域：同一导线上存在冲突，只能互斥使用，网桥、交换机可以分割冲突域；
广播域：同一网络中可以进行广播，路由器分割广播域。
网桥/交换机组网：
局域网是碰撞域，一次只能一台设备发送信息，局域网中其他设备都能收到信息（也是广播域）；
将设备与网桥的每个端口分别连接，一个端口对应了一个碰撞域，如果一台设备独占一个端口，则没有碰撞；
可以增加总带宽，n个端口就是n倍带宽。
自学习：根据收到帧的端口，确定主机的位置，从而自动生成路由表

  交换机转发帧：
收到帧，根据目的地址，查找mac地址（CAM）表：
目的地址在帧发来的一端：丢弃
mac表中查到目的地址对应端口：转发到对应端口
mac表中查不到：转发到所有端口，除了发来帧的端口
自学习：每次收到新的源mac的帧，都添加“mac-端口”条目到mac表
3层交换机：能处理ip地址，使用ARP根据目标ip，广播查询目标mac

3.3
交换机端口扩展了信道资源，一个端口一个广播域。
vlan：利用多个交换机即软件，分割广播域为多个虚拟局域网

区别？
有线通讯：带宽高、出错率低、频谱复用方便，但不支持移动应用
无线通讯：带宽低、出错率高、（近距离）频谱复用困难，但支持移动应用

【以太网原理】
若干设备共享总线（信道），广播，总线独占使用（类似进程调度中的cpu分配）
CSMA/CD（载波监听，多路访问，碰撞检测）
\- 发前先听（看能否使用临界资源）
\- 基于最小发送帧长的边发边听（可能发生碰撞的时间最长为一个RTT，即发到对端时对端也开始发送，导致碰撞，因此为了能检测到碰撞发生，至少要听一个RTT的时间，这也决定了报文的最小帧长）
\- 发现冲突后采用二进制指数后退（降低负载量）
\- 立即停发
\- 转发强化
局限性：适合网络负载较低的场景，因而不适合千兆网（最小帧长：RTT*带宽）。

OSI
分层模型的概念
服务
	下层为上层提供服务
	有连接：提供可靠传输、有序的传输，需要预置网络资源
	无连接：只依据局部的、不完整的信息就可以完成传输，只适合低负载的网络，不能实现可靠、有序，不预置网络资源
2.接口
3.封装
致命缺陷：分层结构，上层协议依赖于下层协议，带来性能问题，只适合在网络负载较低的情形。不能全局优化。低层的问题交给高层去优化解决，不可能，只在网络低负载时可行。

数据链路层：
差错控制：
纠错码，超时计时器，帧序号
流量控制：

网络层：分组转发
传输层：进程到进程的报文交付



LAN
最小帧长：
源于碰撞检测机制，最坏情况下发送的对端才发送碰撞，碰撞传回，总共经过2倍的转播时间：
标准以太网（10Mbps）最大传播时间为25.6us，最小帧长25.6us * 2 * 10M = 512bit = 64B
首部+CRC共18B，因此payload至少46B，最大1500B，超过会分开发送。
（数据传输率越大，网线的允许长度越短；1000M通过交换机实现全双工，不再用CSMA/CD）

WLAN
CSMA/CA碰撞避免：RTS，CTS握手，数据，ACK
握手时，仅收到CTS帧的节点说明有隐藏节点
帧格式复杂，因为覆盖了分布式信道，以及集中式信道。
隐藏站，暴露站。



# chap 4 网络层

**分组交换**：对于同一来源同一目的的分组，虽然网络层提供了将不同分组发到不同路由（动态路由）的能力，但通常路由表不会经常的变化，因此路由器一般会为这些报文选择同一条（最优的）路由。无连接的分组交换：（适合网络负载低时）
优点：独立的处理每个一分组，在分组的逐跳转发过程中，只需要知道局部的网络信息，就可以进行路由选择，是局部优化的路由选择过程；不需要资源的预置。
缺点：不能进行可靠传输、不能有序传输

**面向连接的分组交换**：（适合网络负载高时）
优点：可靠传输，有序传输，资源预置
不足：需要知道全局的网络状态信息（可以分治的获取）  



# chap 5

判断ip地址类别：

第一位为0：A类（0-127）

第二位为0：B类（127-191）

第三位为0：C类（192-223）

第四位为0：D类（224-239，多播，32位都是网络号）

第五位为0：E类（240-255，保留，32位都是网络号）



子网划分：一个交换机由于端口有限，无法连接一个局域网内所有主机——将一个网络划分为多个子网，每个子网一个交换机。
超网：将多个网络合并，减少路由表表项。但合并的网络数量必须为2的倍数。
无分类编址：将ip分为网络号与主机号，斜线/CIDR记法。如果不指定网络掩码，则同一个ip可以对应多个网络地址块。
NAT：网络地址转换，内网主机出网共用同一个公共IP。适合无连接的互联。  





#   chap 06

直接交付：目的地与发送者处于同一网络，arp查找出mac，直接发送，没有下一跳。
转发：路由器根据目的ip查询路由表，确定下一跳路由器ip，转发到这个路由器的mac地址上。

无连接路由缺点：
每次只根据到下一跳的代价进行路由选择，这样选取的“最小代价”只是局部最小，不一定是全局最优的路由（不满足最优子结构性质，难以用分治寻找全局最优）
然而既然下一跳已经决定，一旦这个下一跳结点故障，则。。。，局部问题又变为了全局问题。

路由表中子网划分是用于内部路由器的，
基于无分类地址的**路由表**：掩码，网络地址，下一跳ip，接口。
过程：目的地ip与掩码与操作，获得网络号，与路由表中网络号是否匹配，是则从接口转发。
最长前缀匹配：路由表中，从上至下，掩码长度递减。因为前缀越长，粒度越细，且短前缀的地址块包含长前缀的地址块。

# chap 7

分片
数据报的重组只在目的主机上进行。
片偏移以8B为单位，计算方法：该分片第一个字节的编号/8。
除了最后一个分片，其他分片都有More frag标志位。
老师说，以太网直接在发送端以536B为单位分片。

报头选项
选项结束选项：只能出现一次
记录路由选项：路由器填写自己的出口ip
严格源路由选项：数据包*只能且一定要*经过选项中的路由（入口ip），所有分片都要复制该选项。
宽松源路由选项：表中路由器必须经过，还可以经过其他路由器，所有分片都复制。
时间戳：出口ip + 时间戳

校验和
每16个比特位相加，得T，最后取反，即为校验和-T；
接受端进行同样操作，先求和再取反（T+(-T) = 全1，取反就变为全0，说明没出错），T-T=1111...1=-0，-(-0)=0，即没有出错。

只校验首部的原因：
高层协议自带校验
每次经过路由器，只有首部发生变化
每个路由器都重复校验数据部分，会降低分组转发效率

# 8 ARP

ARP请求使用广播，ARP回答使用单播。
使用场合：但需要发送ip数据报，但不知道下一跳的mac地址（链路层的帧需要）。

# 9 ICMP

ICMP封装在IP数据报中。

差错报告报文：终点不可达、源点抑制（路由器丢包，发生拥塞，通知源点抑制发送）、超时、参数问题、改变路由

ICMP总是把差错报文报告给数据源。
ICMP差错报文的数据部分包含IP首部+数据部分前8字节
不报错的情况：ICMP差错报文出错、非第一片分片、多播地址、特殊地址

查询报文：

回送请求-回答（echo，测试主机可达性）、时间戳请求-应答（两个机器往返时间）

ping：利用echo计算RTT。

traceroute：利用TTL=0、UDP不支持的端口、路由器回送的超时、终点不可达报文中可以获得路由器IP。



# 11 单播路由选择协议

解决问题：路由器如何建立路由表？

路由的关键是以多少的代价获得相应的网络信息。

**RIP**
基于距离向量distance vector
度量是“跳数”，无穷大为16
使用Bellman-Ford算法，计算单源最短路径。
udp
定期更新：30s左右向邻居发送一次自己的路由表，从而触发更新

缺点：
定期更新太短。且不必要，因为一旦网络状态发生变化，会发送通告。
路径的度量只能是跳数。
收敛性，坏消息可能传的慢（第一版中的问题，第二版中增加了下一跳信息，分割范围+毒性反转，从而解决）。



**OSPF**
基于链路状态
度量是可变的
每个结点生成自己的链路状态分组LSP，通过可靠的方法flooding到整个网络
最终每个结点存储一个“全局”的链路状态，即完整的网络拓扑，通过Dijkstra算法计算一棵最小生成树。
ip数据报（无连接，带确认）

缺点：
可靠的flooding广播，邻居收到flooding之后还要发送确认，通信量较大。
其实获取全局信息代价较大，且可能过时。
实现较复杂。



**BGP**
路径向量：每个主干路由器记录自己自治区域AS内的网络（用于表示可达性），不同AS的主干路由器交互该路由表，从而知道要达到目的网络，需要经过哪些自治系统。
tcp



# 13 传输层

序号+确认号：**差错控制**。检查重复分组、分组有序到达、重传哪个分组。
滑动窗口：**流量控制**。窗口是发送缓冲区，包含已发送但未被确认的分组和剩余可发送空间，下标表示分组的序号，窗口大小是连接的容量（依据网络的容量，而不是接收方），收到确认号，窗口向前滑动。

停等协议：大小为1的滑动窗口。（只需要两个序号即可区分分组，0和1，mod2运算）
返回N协议：发送方可以一次性发送多个分组（2^m -1，mod m）。接收方窗口大小只有1，一旦分组进入接收缓冲区就回送一个ACK，ACK的值是期望收到的下一个分组的序号，采用<u>累计确认</u>，即发送窗口可以根据最新ACK一次向前滑动更远的距离。

选择重传协议：发送窗口和接收窗口一样大（2^m /2），从而接收缓冲区可以<u>暂时缓存失序</u>到达的分组。接收方收到哪个分组，就回送ACK=这个分组的序号，而不是累计确认。

# 14 UDP

完成进程到进程的通信、传输层控制机制、差错控制（丢弃），没有流量控制、拥塞控制。

校验和：伪首部（包含IP） + UDP首部 + 数据

# 15 TCP

连接的含义：可靠的传输、按序的传输、资源的使用。
编号系统：字节编号，ACK是期望收到的下一字节编号，<u>累计确认</u>（也有选择确认）。失序到达、重复到达、空缺分组到达都要立刻回送期望有序收到的下一个ACK。
紧急指针：该数值+seq，得到该报文最后一个紧急字节的编号，该字节之前的数据全部都是紧急数据。
注意：如果报文中不携带数据，则seq应该是上次发送数据的最后一个字节的编号（单纯的ACK确认报文就是这种类型）
接受端每次通告rwnd，发送窗口如果收缩，必须保证发送窗口右壁不能左移。（即使发送方的窗口以及关闭了，也可以发送含一个字节数据的探测报文，防止死锁）



**流量控制**

滑动窗口

糊涂窗口综合征

解决办法：减少发送分组数目，一次性发送大块的数据以提高利用率。

- 发送端产生小块数据：nagle算法，发送一个分组后，累积数据，直到累计了一个MSS或收到ACK，才能发下一次分组。（确认到的越快，发的越快）
- 接受端消耗小块数据：接收端延迟确认，仅有一个分组到达时，先不确认，直到收到第二个有序到达的分组或经过500ms，才发ACK，这样发送端滑动窗口一次性可以滑动更远的距离，也就可以一次性发送更多的数据。  



**差错控制**

校验和、确认、重传（超时重传，三个ACK的快重传）



**拥塞控制**

见文件夹UNP-协议-TCP拥塞控制

真正的窗口大小：min(rwnd, cwnd)，接收窗口、拥塞窗口的最小值



