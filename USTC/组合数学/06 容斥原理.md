# 6 容斥原理

另一种间接计数的方法，**减法原理的扩充**，容斥原理中，集合之间是否相交没有限制。



**容斥原理**

设P1，P2，...，Pm是集合S的对象涉及的m个性质，并设Ai是S中具有性质Pi的对象构成的子集合，Ai∩Aj表示同时具有性质Pi和Pj，则集合S中不具有性质P1，P2，...，Pm的对象个数为：
$$
\begin{align}
|\overline{A}_1 \cap \overline{A}_2 \cap \dots \cap \overline{A}_m|
=\ &|S| -\sum|A_i| + \sum|A_i \cap A_j| - \sum|A_i \cap A_j \cap A_k| \\
&+ \dots + (-1)^m|A_1 \cap A_2 \cap \dots \cap A_m|
\end{align}
$$

- lhs的语义是既不P1，又不P2，...（如果需要求既...又...的类型，可以先把性质取反，再使用容斥原理）
- rhs的符号是正负交替的
- 第一项|S|可以看成是m个性质{1, 2, ..., m}中具有零个性质的集合（0子集）；第一个和Σ|Ai|是具有一个性质的集合（1子集）；第二个和表示同时具有两个性质（2子集），...，最后一项是具有m个性质的集合（m子集）
- 则rhs的总项数为服从二项式定理：(m 0) + (m 1) + ... + (m m) = 2^m 。

证明：只要证具有 n≥1 个性质的对象y 对 rhs 的贡献为 0 即可。显然y在{A1, A2, ... Am}中的n个中。y对第一项|S|的贡献为(n 0)，对第一个和的贡献为(n 1)，...，得到总贡献 = (n 0) - (n 1) + (n 2) - ... +(-1)^m (n n) = (1-1)^n = 0。



**简化**

如果每个和中，每一项的值相同，即
$$
\begin{align}
\alpha_0 &= |S| \\
\alpha_1 &= |A_1|=|A_2|=\dots=|A_m|\\
\alpha_2 &= |A_1\cap A_2|=\dots=|A_{m-1}\cap A_m|\\
\vdots\\
\alpha_m &= |A_1 \cap A_2 \cap \dots \cap A_m|
\end{align}
$$
则原式可简化为
$$
\begin{align}
|\overline{A}_1 \cap \overline{A}_2 \cap \dots \cap \overline{A}_m|
=&\ \alpha_0 - \begin{pmatrix} m\\1 \end{pmatrix}\alpha_1 +\begin{pmatrix} m\\2 \end{pmatrix}\alpha_2+\dots \\
&+(-1)^k\begin{pmatrix} m\\k \end{pmatrix}\alpha_m
+\dots+(-1)^m\begin{pmatrix} m\\m \end{pmatrix}\alpha_m
\end{align}
$$



**推论**

集合S中至少具有性质P1，P2，...，Pm之一的对象个数是：
$$
\begin{align}
|A_1 \cup A_2 \cup \dots \cup A_m|
=&\ |S| -|\overline{A}_1 \cap \overline{A}_2 \cap \dots \cap \overline{A}_m| \\
=& \sum|A_i| - \sum|A_i \cap A_j| + \sum|A_i \cap A_j \cap A_k| \\
& + \dots + (-1)^{m+1}|A_1 \cap A_2 \cap \dots \cap A_m|
\end{align}
$$



### 应用：多重集合的组合（有限重复数、上界）

chap 2中，无限重复数的多重集合组合可以看成是求一个方程的非负整数解，这相当于是限定了方程中每个变量的“下界”为0。

对于有限重复数的多重集合，相当于再限定了变量的“上界”，这个上界的值就是重复数。

“上界”问题又可以通过先求与它相反的“下界”问题，然后利用容斥原理将这个下界部分减去得到解。

**问题**：方程
$$
x_1 + x_2 + x_3 + x_4 = 18
$$
有限制
$$
1\leq x_1 \leq 5,\quad -2\leq x_2\leq4 ,\quad 0\leq x_3\leq 5,\quad 3\leq x_4\leq 9
$$
求方程的整数解的数目。

**转化**：根据下界，引入变量
$$
y_1 = x_1 - 1,\quad y_2 = x_2 +2,\quad y_3 = x_3,\quad y_4 = x_4 - 3
$$
代换，方程变为
$$
y_1 + y_2 + y_3 + y_4 = 16
$$
条件
$$
0\leq y_1 \leq 4,\quad 0\leq y_2\leq6 ,\quad 0\leq y_3\leq 5,\quad 0\leq y_4\leq 6
$$

此时“下界”变成了0，相当于求非负整数解。

**应用容斥原理求解**：

设S是新方程的所有非负整数解的集合，设P1是y1≥5的性质（注意到这个性质是通过把y1的上界取反得到的），P2是y2≥7的性质，P3是y1≥6的性质，P4是y4≥6的性质。Ai表示S中满足性质Pi的解组成的集合。

先求所有非负整数解的集合：
$$
|S| = \begin{pmatrix} 16+4-1\\16 \end{pmatrix} = \begin{pmatrix} 19\\16 \end{pmatrix} =969
$$
求满足性质P1的集合，此时变成“下界”问题，用同样方法，变量代换（z1=y1-5，z2=y2，z3=y3，z4=y4），方程 z1 + z2 + z3 + z4 = 11的非负整数解为：
$$
|A_1| = \begin{pmatrix} 11+4-1\\11 \end{pmatrix} = 364
$$
后续过程用类似的变量代换，最后使用容斥原理的公式即可。



### 应用：错位排列

定义：集合 {1, 2, 3, ..., n} 的一个错位排列是，每个元素都不在其自然位置上（如元素 1 不能在排列的第一个位置）。

n个元素的错位排列的种类数目为：
$$
D_n = n!(1-\frac{1}{1!}+\frac{1}{2!}-\frac{1}{3!}+\dots+(-1)^n\frac{1}{n!})
$$
证明：（容斥原理）设 S 是 {1, 2, 3, ..., n} 的排列，集合 Ai 表示 S 中第 i 个元素在其自然位置上的排列。Ai表示固定第 i 个元素的位置，则有 |A1| = |A2| = ... = (n-1)! ，同理，|Ai ∩ Aj| = (n-2)!，...，应用容斥原理公式：Dn = n! - (n 1)(n-1)! + (n 2)(n-2)! - ....，得证。

**无穷级数1/e的展开式**
$$
e^{-1} = 1-\frac{1}{1!}+\frac{1}{2!}-\frac{1}{3!}+\frac{1}{4!}-\dots
$$
可以写成
$$
e^{-1} = \frac{D_n}{n!} + (-1)^{n+1}\frac{1}{(n+1)!} + (-1)^{n+2}\frac{1}{(n+2)!} + \dots
$$

- 1/e 与 Dn/n! 之差小于 1/(n+1)!
- Dn 是最接近 n!/e 的**整数**
- n ≥ 7 时，1/e 与 Dn/n! 至少三位小数相同，应用中可认为它们是一样的
- Dn/n! 的概率意义：分子是n个元素的错排，分母是n个元素的全排列。它表示随机选取一个排列，选到错排的概率是1/e。

**递推公式**
$$
D_n = (n-1)(D_{n-2}+D_{n-1})
$$
初始值：D1=0，D2=1

证明：第一个位置有n-1种选择。如果第二个位置放第一个元素，则后面的位置是Dn-2错排；去掉前一种情况后，剩下第二个位置不允许放第一个元素，则变成Dn-1错排。

另一个递推关系：
$$
D_n = nD_{n-1}+(-1)^n
$$



### 带有禁止位置的排列（错排的推广）

错排：每个位置，存在且仅存在⼀个元素不能放⼊该位置。

推广：每个位置，存在**一些**元素不能放⼊该位置：

用P(X1, X2, ..., Xn) 表示n排列的集合，其中第1个位置上不能含有集合X1中的元素，第2个位置上不能含有X2中的元素，...，Xi也叫禁止位置。

**带有禁止位置的非攻击型车**

将n个带有禁止位置的非攻击型车放到n*n棋盘上的放置方法数等于
$$
n! - r_1(n-1)! + r_2(n-2)! - \dots + (-1)^kr_k(n-k)! + \dots + (-1)^nr_n
$$
- 其中r_k 表示把k个非攻击型车，放到禁止位置上的放法数目。（如r2表示选择2个行的车放到禁止位置上的方法数，则剩下n-2个车有(n-2)!种放法）

证明：（容斥原理）S为不含禁⽌位置的排列，A1表示第1个位置**含**X1中元素的排列集合，...。第1行的车放在X1中的列上，有|X1|种放法，剩余n-1个车有(n-1)!种放法。Σ|Ai| = (|X1| + |X2| + ... + |Xn|) * (n-1)!，r1等于棋盘上禁止放车的方格个数。

求rk的技巧：可以先把棋盘重排，把禁止位置拆分成几个独立的集合，则从两个相互独立的集合中找禁止位置的放法可以使用乘法原理来算。

